(function(){"use strict";function t(t,o){!t||0===t.length&&t!=window||(t.length?Array.prototype.forEach.call(t,function(t,e){o(t)}):o(t))}function o(t,e){return t?t.parentNode==e?!0:o(t.parentNode,e):!1}function e(t){return"string"==typeof t}function i(o,e,i,n){t(o,function(t){var o=e.split(" ");for(var s in o)t.addEventListener(o[s],i,n)})}function n(o,e){t(o,function(t){if(t.classList){var o=e.split(" ");for(var i in o)t.classList.add(o[i])}else t.className+=" "+e})}function s(o,e){t(o,function(t){if(t.classList){var o=e.split(" ");for(var i in o)t.classList.remove(o[i])}else t.className=t.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," ")})}function l(t){return Array.prototype.slice.call(t,0)}function r(t,o){return t?t.classList?t.classList.contains(o):new RegExp("(^| )"+o+"( |$)","gi").test(t.className):void 0}function p(o,e){t(o,function(t){r(t,e)?s(t,e):n(t,e)})}function u(o,e,i){return void 0===i&&o&&void 0!==o.getAttribute?o.getAttribute(e):void t(o,function(t){t.setAttribute(e,i)})}function d(o,e){t(o,function(t){t.removeAttribute(e)})}function c(t){return t.replace(/(^\s+|\s+$)/g,"")}function h(t,o,e,i){var n,s;o||(o={}),-1!==t.indexOf(".")&&(s=t.split("."),t=s[0],s.shift(),o["class"]=s.join(" ")),-1!==t.indexOf("#")&&(s=t.split("#"),t=s[0],o.id=s[1]),n=document.createElement(t);for(var l in o)n.setAttribute(l,o[l]);return e&&e.appendChild(n),i&&(n.innerHTML=i),n}function a(t){void 0===t&&(t={});var o={};for(var e in y)o[e]=void 0!==t[e]?t[e]:y[e];return o}function f(t){p(t.previousSibling,"combobox-option-focused")}function b(t){p(t.nextSibling,"combobox-option-focused")}function v(t,o){return"next"==o?t.nextSibling?"none"!=t.nextSibling.style.display?t.nextSibling:v(t.nextSibling,o):null:"prev"==o?t.previousSibling?"none"!=t.previousSibling.style.display?t.previousSibling:v(t.previousSibling,o):null:void 0}var m={leftArrow:37,rightArrow:39,upArrow:38,downArrow:40,enter:13,backspace:8,esc:27},w={willadd:"onWillAdd",willremove:"onWillRemove",willopen:"onWillOpen",willclose:"onWillClose",willload:"onWillLoad",didadd:"onDidAdd",didremove:"onDidRemove",didopen:"onDidOpen",didclose:"onDidClose",didload:"onDidLoad"},y={options:null,selected:null,delimiter:",",create:!0,createOnBlur:!0,openOnFocus:!0,maxSelected:0,closeAfterSelect:!0,selectOnTab:!0,onWillAdd:null,onWillRemove:null,onWillOpen:null,onWillClose:null,onWillLoad:null,onDidAdd:null,onDidRemove:null,onDidOpen:null,onDidClose:null,onDidLoad:null},g=function(o,n){this.opt=a(n),this.el=e(o)?document.querySelector(o):o,o&&(this.el.style.display="none",this.isSelectBox="select"==this.el.nodeName.toLowerCase(),this.container=h("div.combobox"),this.el.parentNode.insertBefore(this.container,this.el),this.container.appendChild(this.el),this.inputContainer=h("div.combobox-input-container",null,this.container),this.dropdown=h("div.combobox-dropdown",null,this.container),this.values=[],this.items=[],this.isSelectBox&&t(this.el.querySelectorAll("option"),function(t){this.items.push(t.textContent),null!==u(t,"selected")&&void 0!==u(t,"selected")&&(h("div.combobox-option",null,this.inputContainer,t.textContent),this.values.push(t.textContent))}.bind(this)),this.inputEl=h("input.combobox-input",null,this.inputContainer),this.tempEl=h("div.combobox-temp",null,this.container),this.tempEl.style.letterSpacing=this.inputEl.style.letterSpacing,this.tempEl.style.fontSize=this.inputEl.style.fontSize,this.tempEl.style.fontFamily=this.inputEl.style.fontFamily,this.tempEl.style.fontWeight=this.inputEl.style.fontWeight,this.tempEl.style.textTransform=this.inputEl.style.textTransform,u(this.inputContainer,"placeholder",u(this.el,"placeholder")),i(this.inputContainer,"focus click",this.focus.bind(this)),i(this.inputEl,"focus",this.focus.bind(this)),i(this.inputEl,"input",this.onInput.bind(this)),i(this.inputEl,"keydown",this.onKeyDown.bind(this)),i(document.documentElement,"click",this.onClick.bind(this)),i(document.documentElement,"mouseover",this.onHover.bind(this)),this.togglePlaceholder(),this.resetHeight())};g.prototype.onClick=function(t){o(t.srcElement,this.container)?o(t.srcElement,this.dropdown)&&this.onDropdownOptionClick(t):this.blur()},g.prototype.onHover=function(t){o(t.srcElement,this.container)&&r(t.srcElement,"combobox-dropdown-option")&&this.setDropdownOptionFocus(t.srcElement)},g.prototype.onInput=function(){this.updateInputSize();var t=c(this.getValue());this.filterDropdown(t)},g.prototype.onKeyDown=function(t){switch(t.keyCode){case m.rightArrow:this.onKeyRightArrow(t);break;case m.leftArrow:this.onKeyLeftArrow(t);break;case m.downArrow:this.onKeyDownArrow(t);break;case m.upArrow:this.onKeyUpArrow(t);break;case m.backspace:this.onKeyBackspace(t);break;case m.esc:this.onKeyEsc(t);break;case m.enter:this.onKeyEnter(t)}this.togglePlaceholder()},g.prototype.onKeyEsc=function(t){this.hideDropdown()},g.prototype.onKeyEnter=function(t){var o=this.inputEl.value=c(this.getValue()),e=this.values.indexOf(o)>=0,i=this.dropdown.querySelector(".combobox-dropdown-option-focused");i&&this.addValue(u(i,"data-value"))?(this.moveDropdownOptionFocus("next"),this.resetInput()):(e||this.addValue(o))&&this.resetInput()},g.prototype.onKeyBackspace=function(t){if(0===this.getValue().length){if(this.hasFocused())return void this.removeFocused();if(this.inputEl.previousSibling){var o=this.inputEl.previousSibling.textContent;this.opt.onWillRemove&&this.opt.onWillRemove(o)===!1||(this.isSelectBox&&d(this.findSelectedOption(this.inputEl.previousSibling.textContent),"selected"),this.removeValue(o),this.inputEl.parentNode.removeChild(this.inputEl.previousSibling),this.opt.onDidRemove&&this.opt.onDidRemove(o),this.inputEl.focus(),this.showDropdown())}}},g.prototype.onKeyLeftArrow=function(t){0===this.getValue().length&&(t.shiftKey?f(this.inputEl):this.removeFocus(),this.inputEl.previousSibling&&this.inputEl.parentNode.insertBefore(this.inputEl,this.inputEl.previousSibling),this.inputEl.focus())},g.prototype.onKeyRightArrow=function(t){0===this.getValue().length&&(t.shiftKey?b(this.inputEl):this.removeFocus(),this.inputEl.nextSibling?this.inputEl.parentNode.insertBefore(this.inputEl,this.inputEl.nextSibling.nextSibling):this.inputEl.parentNode.appendChild(this.inputEl),this.inputEl.focus())},g.prototype.onKeyUpArrow=function(t){this.moveDropdownOptionFocus("prev")},g.prototype.onKeyDownArrow=function(t){this.moveDropdownOptionFocus("next")},g.prototype.onDropdownOptionClick=function(t){var o=t.srcElement;r(o,"combobox-dropdown-option")&&this.addValue(o.textContent)&&(this.resetInput(),this.showDropdown(),this.inputEl.focus())},g.prototype.updateInputSize=function(){this.tempEl.innerHTML=this.getValue(),this.inputEl.style.width=this.tempEl.offsetWidth+4+"px",this.togglePlaceholder()},g.prototype.togglePlaceholder=function(){1===this.inputEl.parentNode.childNodes.length&&0===this.getValue().length?n(this.inputEl.parentNode,"combobox-placeholder"):s(this.inputEl.parentNode,"combobox-placeholder")},g.prototype.removeFocus=function(){s(this.inputEl.parentNode.querySelectorAll(".combobox-option-focused"),"combobox-option-focused")},g.prototype.hasFocused=function(){return this.inputEl.parentNode.querySelectorAll(".combobox-option-focused").length>0},g.prototype.removeFocused=function(){t(this.inputEl.parentNode.querySelectorAll(".combobox-option-focused"),function(t){this.removeValue(t.textContent),t.parentNode.removeChild(t)}.bind(this)),this.showDropdown()},g.prototype.clearDropdownOptionFocus=function(){var t=this.dropdown.querySelector(".combobox-dropdown-option-focused");t&&"none"==t.style.display&&s(t,"combobox-dropdown-option-focused")},g.prototype.setDropdownOptionFocus=function(t){var o=this.dropdown.querySelector(".combobox-dropdown-option-focused");o&&s(o,"combobox-dropdown-option-focused"),t&&n(t,"combobox-dropdown-option-focused")},g.prototype.moveDropdownOptionFocus=function(t){var o=this.dropdown.querySelectorAll(".combobox-dropdown-option");if(o){var e=this.dropdown.querySelector(".combobox-dropdown-option-focused");if(!e)return void n(o[0],"combobox-dropdown-option-focused");var i=v(e,t);i&&(i.scrollIntoView(!1),n(i,"combobox-dropdown-option-focused"),s(e,"combobox-dropdown-option-focused"))}},g.prototype.filterDropdown=function(t){for(var o,e=l(this.dropdown.childNodes),i=new RegExp(t,"i"),n=0;n<e.length;n++){var s=e[n],r=u(s,"data-value");if(t&&0!==t.length){var p=i.exec(r);p?(s.style.display="block",s.innerHTML=r.replace(i,'<span class="combobox-highlight">'+p[0]+"</span>"),o||(o=s)):s.style.display="none"}else s.style.display="block",s.innerHTML=r}o?this.setDropdownOptionFocus(o):this.clearDropdownOptionFocus()},g.prototype.populateDropdown=function(){for(var t in this.items){var o=this.items[t],e=this.dropdown.querySelector('[data-value="'+o+'"]');-1==this.values.indexOf(o)?e||h("div.combobox-dropdown-option",{"data-value":o},this.dropdown,o):e&&this.dropdown.removeChild(e)}var i=l(this.dropdown.childNodes);if(!(i.length<2)){i.sort(function(t,o){return u(t,"data-value").toLowerCase().localeCompare(u(o,"data-value").toLowerCase())});for(var n=0;n<i.length;n++)i[n].parentNode.appendChild(i[n])}},g.prototype.showDropdown=function(){this.populateDropdown(),this.dropdown.childNodes.length>0?n(this.container,"combobox-dropdown-visible"):s(this.container,"combobox-dropdown-visible")},g.prototype.hideDropdown=function(){s(this.container,"combobox-dropdown-visible"),this.setDropdownOptionFocus()},g.prototype.removeValue=function(t){var o=this.values.indexOf(t);return-1!=o?(this.values.splice(o,1),!0):!1},g.prototype.addValue=function(t){if(0===t.length)return!1;var o=this.items.indexOf(t)>=0,e=this.values.indexOf(t)>=0;if(e)return!1;if(!o&&!this.opt.create)return!1;if(this.opt.onWillAdd&&this.opt.onWillAdd(t)===!1)return!1;if(this.values.push(t),o&&this.items.push(t),this.isSelectBox){var i=this.findOption(t);i?(null===u(i,"selected")||void 0===u(i,"selected"))&&u(i,"selected",""):(i=h("option",null,this.el,t),u(i,"selected",""))}else this.el.value=this.values.join(this.opt.delimiter);var n=h("div.combobox-option",null,null,t);return this.inputEl.parentNode.insertBefore(n,this.inputEl),this.opt.onDidAdd&&this.opt.onDidAdd(t),this.showDropdown(),this.togglePlaceholder(),this.resetHeight(),!0},g.prototype.findSelectedOption=function(o){var e;return t(this.el.querySelectorAll("option[selected]"),function(t){t.textContent==o&&(e=t)}.bind(this)),e},g.prototype.findOption=function(o){var e;return t(this.el.querySelectorAll("option"),function(t){t.textContent==o&&(e=t)}.bind(this)),e},g.prototype.getValue=function(){return this.inputEl.value},g.prototype.focus=function(){this.inputEl.focus(),this.showDropdown()},g.prototype.blur=function(){this.inputEl.blur(),this.hideDropdown()},g.prototype.getItems=function(){return this.items},g.prototype.getValues=function(){return 1===this.opt.maxSelected?this.values[0]:this.values},g.prototype.resetHeight=function(){var t=this.inputContainer.getBoundingClientRect();this.container.style.maxHeight=t.height+"px"},g.prototype.resetInput=function(){this.inputEl.value="",this.updateInputSize(),this.filterDropdown()},g.prototype.on=function(t,o){w[t]&&(this.opt[w[t]]=o)},this.ComboBox=function(t,o){var e=new g(t,o);return e},this.ComboBox.globals=y}).call(this);