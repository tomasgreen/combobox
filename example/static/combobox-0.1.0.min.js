(function(){"use strict";function t(t,o){!t||0===t.length&&t!=window||(t.length?Array.prototype.forEach.call(t,function(t,e){o(t)}):o(t))}function o(t,e){return t?t.parentNode==e?!0:o(t.parentNode,e):!1}function e(t){return"string"==typeof t}function i(o,e,i,n){t(o,function(t){var o=e.split(" ");for(var s in o)t.addEventListener(o[s],i,n)})}function n(o,e){t(o,function(t){if(t.classList){var o=e.split(" ");for(var i in o)t.classList.add(o[i])}else t.className+=" "+e})}function s(o,e){t(o,function(t){if(t.classList){var o=e.split(" ");for(var i in o)t.classList.remove(o[i])}else t.className=t.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," ")})}function l(t){return Array.prototype.slice.call(t,0)}function r(t,o){return t?t.classList?t.classList.contains(o):new RegExp("(^| )"+o+"( |$)","gi").test(t.className):void 0}function p(o,e){t(o,function(t){r(t,e)?s(t,e):n(t,e)})}function u(o,e,i){return void 0===i&&o&&void 0!==o.getAttribute?o.getAttribute(e):void t(o,function(t){t.setAttribute(e,i)})}function h(t){return t.replace(/(^\s+|\s+$)/g,"")}function c(t,o,e,i){var n,s;o||(o={}),-1!==t.indexOf(".")&&(s=t.split("."),t=s[0],s.shift(),o["class"]=s.join(" ")),-1!==t.indexOf("#")&&(s=t.split("#"),t=s[0],o.id=s[1]),n=document.createElement(t);for(var l in o)n.setAttribute(l,o[l]);return e&&e.appendChild(n),i&&(n.innerHTML=i),n}function a(t){void 0===t&&(t={});var o={};for(var e in m)o[e]=void 0!==t[e]?t[e]:m[e];return o}var d={leftArrow:37,rightArrow:39,upArrow:38,downArrow:40,enter:13,backspace:8,esc:27},f={willadd:"onWillAdd",willremove:"onWillRemove",willopen:"onWillOpen",willclose:"onWillClose",willload:"onWillLoad",didadd:"onDidAdd",didremove:"onDidRemove",didopen:"onDidOpen",didclose:"onDidClose",didload:"onDidLoad"},m={options:null,values:null,delimiter:",",create:!0,createOnBlur:!0,openOnFocus:!0,closeAfterSelect:!0,selectOnTab:!0,maxSelected:0,maxSuggestions:1/0,onWillAdd:null,onWillRemove:null,onWillOpen:null,onWillClose:null,onWillLoad:null,onDidAdd:null,onDidRemove:null,onDidOpen:null,onDidClose:null,onDidLoad:null},v=function(o,n){this.opt=a(n),this.el=e(o)?document.querySelector(o):o,o&&(this.el.style.display="none",this.isSelectBox="select"==this.el.nodeName.toLowerCase(),this.container=c("div.combobox"),this.el.parentNode.insertBefore(this.container,this.el),this.container.appendChild(this.el),this.inputContainer=c("div.combobox-input-container",null,this.container),this.dropdown=c("div.combobox-dropdown",null,this.container),this.values=[],this.items=[],this.isSelectBox&&t(this.el.querySelectorAll("option"),function(t){this.items.push(t.textContent),null!==u(t,"selected")&&void 0!==u(t,"selected")&&this.values.push(t.textContent)}.bind(this)),this.inputEl=c("input.combobox-input",null,this.inputContainer),this.completionEl=c("div.combobox-input-completion"),this.tempEl=c("div.combobox-temp",null,this.container),this.tempEl.style.letterSpacing=this.inputEl.style.letterSpacing,this.tempEl.style.fontSize=this.inputEl.style.fontSize,this.tempEl.style.fontFamily=this.inputEl.style.fontFamily,this.tempEl.style.fontWeight=this.inputEl.style.fontWeight,this.tempEl.style.textTransform=this.inputEl.style.textTransform,u(this.inputContainer,"placeholder",u(this.el,"placeholder")),i(this.inputContainer,"focus click",this.focus.bind(this)),i(this.inputEl,"focus",this.focus.bind(this)),i(this.inputEl,"input",this.onInput.bind(this)),i(this.inputEl,"keydown",this.onKeyDown.bind(this)),i(document.documentElement,"click",this.onClick.bind(this)),i(document.documentElement,"mouseover",this.onHover.bind(this)),this.togglePlaceholder(),this.resetHeight())};v.prototype.onClick=function(t){o(t.srcElement,this.container)?o(t.srcElement,this.dropdown)&&this.onDropdownOptionClick(t):this.blur()},v.prototype.onHover=function(t){o(t.srcElement,this.container)&&r(t.srcElement,"combobox-option")&&this.setDropdownOptionFocus(t.srcElement)},v.prototype.onInput=function(){this.updateInputSize(),this.updateDropdown()},v.prototype.onKeyDown=function(t){switch(t.keyCode){case d.rightArrow:this.onKeyRightArrow(t);break;case d.leftArrow:this.onKeyLeftArrow(t);break;case d.downArrow:this.onKeyDownArrow(t);break;case d.upArrow:this.onKeyUpArrow(t);break;case d.backspace:this.onKeyBackspace(t);break;case d.esc:this.onKeyEsc(t);break;case d.enter:this.onKeyEnter(t)}},v.prototype.onKeyEsc=function(t){this.hideDropdown()},v.prototype.onKeyEnter=function(t){var o=this.inputEl.value=h(this.getInputValue()),e=this.values.indexOf(o)>=0,i=this.dropdown.querySelector(".combobox-option-focused");i&&this.addValue(u(i,"data-value"))?this.resetInput():(e||this.addValue(o))&&this.resetInput()},v.prototype.onKeyBackspace=function(t){if(0===this.getInputValue().length||!(this.inputEl.selectionStart>0||this.inputEl.selectionStart!=this.inputEl.selectionEnd)){if(this.hasFocused())return void this.removeFocused();if(this.inputEl.previousSibling){var o=this.inputEl.previousSibling.textContent;this.opt.onWillRemove&&this.opt.onWillRemove(o)===!1||(this.removeValue(o),this.inputEl.parentNode.removeChild(this.inputEl.previousSibling),this.opt.onDidRemove&&this.opt.onDidRemove(o),this.inputEl.focus(),this.updateDropdown(!0))}}},v.prototype.onKeyLeftArrow=function(t){0===this.getInputValue().length&&(t.shiftKey?this.inputEl.previousSibling&&p(this.inputEl.previousSibling,"combobox-value-focused"):this.removeFocus(),this.inputEl.previousSibling&&this.inputEl.parentNode.insertBefore(this.inputEl,this.inputEl.previousSibling),this.inputEl.focus())},v.prototype.onKeyRightArrow=function(t){0===this.getInputValue().length&&(t.shiftKey?this.inputEl.nextSibling&&p(this.inputEl.nextSibling,"combobox-value-focused"):this.removeFocus(),this.inputEl.nextSibling?this.inputEl.parentNode.insertBefore(this.inputEl,this.inputEl.nextSibling.nextSibling):this.inputEl.parentNode.appendChild(this.inputEl),this.inputEl.focus())},v.prototype.onKeyUpArrow=function(t){this.moveDropdownOptionFocus("prev"),t.preventDefault()},v.prototype.onKeyDownArrow=function(t){this.moveDropdownOptionFocus("next"),t.preventDefault()},v.prototype.onDropdownOptionClick=function(t){var o=t.srcElement;r(o,"combobox-option")&&this.addValue(u(o,"data-value"))&&(this.resetInput(),this.updateDropdown(),this.inputEl.focus())},v.prototype.updateInputSize=function(){this.tempEl.innerHTML=this.getInputValue(),this.inputEl.style.width=this.tempEl.offsetWidth+4+"px"},v.prototype.toggleCompletion=function(){var t=this.dropdown.querySelector(".combobox-option-focused"),o=u(t,"data-value"),e=this.getInputValue();t&&0!==e.length&&o&&0===o.toLowerCase().indexOf(e.toLowerCase())?(this.completionEl.textContent=o.substring(e.length),this.inputEl.nextSibling?this.inputEl.parentNode.insertBefore(this.completionEl,this.inputEl.nextSibling):this.inputEl.parentNode.appendChild(this.completionEl)):(this.completionEl.textContent="",this.completionEl.parentNode&&this.completionEl.parentNode.removeChild(this.completionEl))},v.prototype.togglePlaceholder=function(){u(this.inputContainer,"data-completion")||1!==this.inputEl.parentNode.childNodes.length||0!==this.getInputValue().length?s(this.inputEl.parentNode,"combobox-placeholder"):n(this.inputEl.parentNode,"combobox-placeholder")},v.prototype.removeFocus=function(){s(this.inputEl.parentNode.querySelectorAll(".combobox-value-focused"),"combobox-value-focused")},v.prototype.hasFocused=function(){return this.inputEl.parentNode.querySelectorAll(".combobox-value-focused").length>0},v.prototype.removeFocused=function(){t(this.inputEl.parentNode.querySelectorAll(".combobox-value-focused"),function(t){this.removeValue(t.textContent),t.parentNode.removeChild(t)}.bind(this)),this.updateDropdown()},v.prototype.clearDropdownOptionFocus=function(){var t=this.dropdown.querySelector(".combobox-option-focused");t&&"none"==t.style.display&&s(t,"combobox-option-focused")},v.prototype.setDropdownOptionFocus=function(t){var o=this.dropdown.querySelector(".combobox-option-focused");o&&s(o,"combobox-option-focused"),t&&n(t,"combobox-option-focused")},v.prototype.moveDropdownOptionFocus=function(t){var o=this.dropdown.querySelectorAll(".combobox-option");if(o){var e=this.dropdown.querySelector(".combobox-option-focused");if(!e)return void n(o[0],"combobox-option-focused");var i;"next"==t&&e.nextSibling?i=e.nextSibling:"prev"==t&&e.previousSibling&&(i=e.previousSibling),i&&(i.scrollIntoView(!1),n(i,"combobox-option-focused"),s(e,"combobox-option-focused"),this.toggleCompletion())}},v.prototype.toggleHighlight=function(){for(var t,o=h(this.getInputValue()),e=l(this.dropdown.childNodes),i=new RegExp(o,"i"),n=0;n<e.length;n++){var s=e[n];t||(t=s);var r=u(s,"data-value");if(o&&0!==o.length){var p=i.exec(r);s.innerHTML=r.replace(i,'<span class="combobox-highlight">'+p[0]+"</span>")}else s.innerHTML=r}t?this.setDropdownOptionFocus(t):this.clearDropdownOptionFocus()},v.prototype.populateDropdown=function(){var t=this.getInputValue(),o=this.getSuggestions(t);this.dropdown.innerHTML="";for(var e in o){if(e>this.opt.maxSuggestions)break;var i=o[e];c("div.combobox-option",{"data-value":i},this.dropdown,i)}},v.prototype.getSuggestions=function(t){var o=new RegExp(t,"i"),e=this.values,i=this.items.filter(function(t){return e.indexOf(t)>=0?!1:o.test(t)});return i.sort(function(o,e){return e.toLowerCase().indexOf(t)<o.toLowerCase().indexOf(t)?1:e.toLowerCase().indexOf(t)>o.toLowerCase().indexOf(t)?-1:o.toLowerCase().localeCompare(e.toLowerCase())}),i},v.prototype.updateDropdown=function(t){var o=this.getInputValue();(t||this.lastValue!=o)&&(this.populateDropdown(),this.toggleHighlight(),this.togglePlaceholder(),this.showDropdown()),this.lastValue=o,this.toggleCompletion()},v.prototype.showDropdown=function(){this.dropdown.childNodes.length>0?n(this.container,"combobox-dropdown-visible"):s(this.container,"combobox-dropdown-visible")},v.prototype.hideDropdown=function(){s(this.container,"combobox-dropdown-visible"),this.setDropdownOptionFocus()},v.prototype.removeValue=function(t){var o=this.values.indexOf(t);return-1!=o?(this.values.splice(o,1),this.updateElementValue(),!0):!1},v.prototype.addValue=function(t){if(0===t.length)return!1;var o=this.items.indexOf(t)>=0,e=this.values.indexOf(t)>=0;if(e||!o&&!this.opt.create||this.opt.onWillAdd&&this.opt.onWillAdd(t)===!1)return!1;this.values.push(t),o||this.items.push(t);var i=c("div.combobox-value",null,null,t);return this.inputEl.parentNode.insertBefore(i,this.inputEl),this.opt.onDidAdd&&this.opt.onDidAdd(t),this.updateDropdown(!0),this.resetHeight(),this.updateElementValue(),!0},v.prototype.updateElementValue=function(){var t=this.el.nodeName.toLowerCase();if("select"==t){this.el.innerHTML="";for(var o in this.values)c("option",{selected:""},this.el,this.values[o])}else"input"==t?this.el.value=this.values.join(this.opt.delimiter):"textarea"==t&&(this.el.innerHTML=this.values.join(this.opt.delimiter))},v.prototype.focus=function(){this.inputEl.focus(),this.updateDropdown(this.opt.openOnFocus)},v.prototype.blur=function(){this.inputEl.blur(),this.hideDropdown()},v.prototype.getItems=function(){return this.items},v.prototype.getValues=function(){return 1===this.opt.maxSelected?this.values[0]:this.values},v.prototype.getInputValue=function(){return this.inputEl.value},v.prototype.resetHeight=function(){var t=this.inputContainer.getBoundingClientRect();this.container.style.maxHeight=t.height+"px"},v.prototype.resetInput=function(){this.inputEl.value="",this.updateInputSize(),this.updateDropdown(!0)},v.prototype.on=function(t,o){f[t]&&(this.opt[f[t]]=o)},this.ComboBox=function(t,o){var e=new v(t,o);return e},this.ComboBox.globals=m}).call(this);