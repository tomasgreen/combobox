(function(){"use strict";function t(t){if(t)for(;t.firstChild;)t.removeChild(t.firstChild)}function e(t){t&&o(t,function(t){t&&t.parentNode&&t.parentNode.removeChild(t)})}function o(t,e){!t||0===t.length&&t!=window||(t.length?Array.prototype.forEach.call(t,function(t,o){e(t)}):e(t))}function i(t,e){return!!t&&(t.parentNode==e||i(t.parentNode,e))}function n(t){var e=document.createElement("div");return e.innerHTML=t,e.firstChild}function s(t){return"string"==typeof t}function r(t,e,i,n){o(t,function(t){var o=e.split(" ");for(var s in o)t.addEventListener(o[s],i,n)})}function l(t,e){o(t,function(t){if(t.classList){var o=e.split(" ");for(var i in o)t.classList.add(o[i])}else t.className+=" "+e})}function p(t,e){o(t,function(t){if(t.classList){var o=e.split(" ");for(var i in o)t.classList.remove(o[i])}else t.className=t.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," ")})}function u(t){return Array.prototype.slice.call(t,0)}function h(t,e){if(t)return t.classList?t.classList.contains(e):new RegExp("(^| )"+e+"( |$)","gi").test(t.className)}function a(t,e){o(t,function(t){h(t,e)?p(t,e):l(t,e)})}function c(t,e,i){return void 0===i&&t&&void 0!==t.getAttribute?t.getAttribute(e):void o(t,function(t){t.setAttribute(e,i)})}function d(t){return t.replace(/(^\s+|\s+$)/g,"")}function f(t,e,o,i){var n,s;e||(e={}),t.indexOf(".")!==-1&&(s=t.split("."),t=s[0],s.shift(),e.class=s.join(" ")),t.indexOf("#")!==-1&&(s=t.split("#"),t=s[0],e.id=s[1]),n=document.createElement(t);for(var r in e)n.setAttribute(r,e[r]);return o&&o.appendChild(n),i&&(n.innerHTML=i),n}function b(t){void 0===t&&(t={});var e={};for(var o in v)e[o]=void 0!==t[o]?t[o]:v[o];return e}var m={leftArrow:37,rightArrow:39,upArrow:38,downArrow:40,enter:13,backspace:8,esc:27},v={options:null,context:null,items:null,delimiter:",",create:!0,createOnBlur:!0,openOnFocus:!0,closeAfterSelect:!0,selectOnTab:!0,maxSelected:0,maxSuggestions:1/0},g=function(t,e){s(t)?this.el=document.querySelector(t):this.el=t,this.opt=b(e),this.el&&(this.el.style.display="none",this.opt.context||(this.opt.context=document.documentElement||document.body),this.isSelectBox="select"==this.el.nodeName.toLowerCase(),this.container=f("div.combobox"),this.el.parentNode.insertBefore(this.container,this.el),this.container.appendChild(this.el),this.inputContainer=f("div.combobox-input-container",null,this.container),this.dropdown=f("div.combobox-dropdown",null,this.container),this.items=this.opt.items||[],this.options=this.opt.options||[],this.dropdownElements=[],this.isSelectBox&&o(this.el.querySelectorAll("option"),function(t){var e={value:t.textContent,label:t.textContent};this.options.push(e),null!==c(t,"selected")&&void 0!==c(t,"selected")&&this.items.push(e)}.bind(this)),this.inputEl=f("input.combobox-input",null,this.inputContainer),this.completionEl=f("div.combobox-input-completion"),this.addEl=f("div.combobox-add"),this.tempEl=f("div.combobox-temp",null,this.container),this.tempEl.style.letterSpacing=this.inputEl.style.letterSpacing,this.tempEl.style.fontSize=this.inputEl.style.fontSize,this.tempEl.style.fontFamily=this.inputEl.style.fontFamily,this.tempEl.style.fontWeight=this.inputEl.style.fontWeight,this.tempEl.style.textTransform=this.inputEl.style.textTransform,c(this.inputContainer,"placeholder",c(this.el,"placeholder")),r(this.inputContainer,"focus",this.focus.bind(this)),r(this.inputEl,"blur",this.blur.bind(this)),r(this.inputEl,"focus",this.focus.bind(this)),r(this.inputEl,"input",this.onInput.bind(this)),r(this.inputEl,"keydown",this.onKeyDown.bind(this)),r(this.opt.context,"click",this.onClick.bind(this),!1),r(this.opt.context,"mouseover",this.onHover.bind(this)),this.renderItems(),this.renderOptions(),this.togglePlaceholder(),this.resetHeight(),this.el.combobox=this)};g.prototype.onClick=function(t){this.activationEvent=t;var e=t.srcElement;return i(e,this.container)?(i(e,this.dropdown)?this.onDropdownOptionClick(t):h(e,"combobox-item")&&a(e,"combobox-item-focused"),void(document.activeElement.isSameNode(this.inputEl)||this.focus())):void this.blur()},g.prototype.onHover=function(t){this.activationEvent=t;var e=t.srcElement;i(e,this.container)&&(h(e,"combobox-add")||h(e,"combobox-option"))&&this.toggleOptionFocus(e)},g.prototype.onInput=function(t){this.updateInputSize(),this.updateDropdown(),this.onInputDidChange&&this.onInputDidChange(this.getInputValue())},g.prototype.onKeyDown=function(t){switch(t.keyCode){case m.rightArrow:this.onKeyRightArrow(t);break;case m.leftArrow:this.onKeyLeftArrow(t);break;case m.downArrow:this.onKeyDownArrow(t);break;case m.upArrow:this.onKeyUpArrow(t);break;case m.backspace:this.onKeyBackspace(t);break;case m.esc:this.onKeyEsc(t);break;case m.enter:this.onKeyEnter(t)}},g.prototype.onKeyEsc=function(t){this.hideDropdown()},g.prototype.onKeyEnter=function(t){var e=this.inputEl.value=d(this.getInputValue()),o=this.dropdown.querySelector(".combobox-option-focused");o&&this.addValue(c(o,"data-value"))?this.resetInput():(this.findItemByValue(e)>=0||this.addValue(e))&&this.resetInput()},g.prototype.findItemByValue=function(t){return this.items.find(function(e){return e.value==t})},g.prototype.findItemByLabel=function(t){return this.items.find(function(e){return e.label==t})},g.prototype.findOptionByLabel=function(t){return this.options.find(function(e){return e.label==t})},g.prototype.findOptionByValue=function(t){return this.options.find(function(e){return e.value==t})},g.prototype.onKeyBackspace=function(t){if(0===this.getInputValue().length||!(this.inputEl.selectionStart>0||this.inputEl.selectionStart!=this.inputEl.selectionEnd))return this.hasFocused()?(this.removeFocused(),void this.updateInputSize()):void(this.inputEl.previousSibling&&(this.removeValue(c(this.inputEl.previousSibling,"data-value")),this.focusInput(),this.updateInputSize(),this.updateDropdown(!0)))},g.prototype.onKeyLeftArrow=function(t){0===this.getInputValue().length&&(t.shiftKey?this.inputEl.previousSibling&&a(this.inputEl.previousSibling,"combobox-item-focused"):this.removeFocus(),this.inputEl.previousSibling&&this.inputContainer.insertBefore(this.inputEl,this.inputEl.previousSibling),this.focusInput())},g.prototype.onKeyRightArrow=function(t){0===this.getInputValue().length&&(t.shiftKey?this.inputEl.nextSibling&&a(this.inputEl.nextSibling,"combobox-item-focused"):this.removeFocus(),this.inputEl.nextSibling?this.inputContainer.insertBefore(this.inputEl,this.inputEl.nextSibling.nextSibling):this.inputContainer.appendChild(this.inputEl),this.focusInput())},g.prototype.onKeyUpArrow=function(t){this.toggleOptionFocus("prev"),t.preventDefault()},g.prototype.onKeyDownArrow=function(t){this.toggleOptionFocus("next"),t.preventDefault()},g.prototype.onDropdownOptionClick=function(t){var e=t.srcElement;(h(e,"combobox-option")||h(e,"combobox-add"))&&(this.addValue(c(e,"data-value"))&&this.resetInput(),this.focusInput())},g.prototype.toggleCompletion=function(){var t=this.dropdown.querySelector(".combobox-option-focused"),e=c(t,"data-value"),o=this.getInputValue();t&&0!==o.length&&e&&0===e.toLowerCase().indexOf(o.toLowerCase())?(this.completionEl.textContent=e.substring(o.length),this.inputEl.nextSibling?this.inputContainer.insertBefore(this.completionEl,this.inputEl.nextSibling):this.inputContainer.appendChild(this.completionEl)):(this.completionEl.textContent="",this.completionEl.parentNode&&this.completionEl.parentNode.removeChild(this.completionEl))},g.prototype.togglePlaceholder=function(){c(this.inputContainer,"data-completion")||1!==this.inputContainer.childNodes.length||0!==this.getInputValue().length?p(this.inputContainer,"combobox-placeholder"):l(this.inputContainer,"combobox-placeholder")},g.prototype.toggleOptionFocus=function(){var t=this.dropdown.querySelector(".combobox-option-focused");if(arguments[0]&&arguments[0].nodeName)return t&&p(t,"combobox-option-focused"),void l(arguments[0],"combobox-option-focused");var e=this.dropdown.querySelectorAll(".combobox-option");if(!e||0===e.length)return void(this.opt.create&&l(this.addEl,"combobox-option-focused"));if(this.opt.create&&p(this.addEl,"combobox-option-focused"),!t)return void l(e[0],"combobox-option-focused");if(arguments[0]){var o;"next"==arguments[0]?o=t.nextSibling:"prev"==arguments[0]&&(o=t.previousSibling),o&&(l(o,"combobox-option-focused"),p(t,"combobox-option-focused"),this.scrollFocusedOptionIntoView(),this.toggleCompletion())}},g.prototype.toggleAdd=function(){var t=d(this.getInputValue());0===t.length?(this.addEl.textContent="",c(this.addEl,"data-value","")):(this.addEl.textContent="Add "+t,c(this.addEl,"data-value",t))},g.prototype.scrollFocusedOptionIntoView=function(){var t=this.dropdown.querySelector(".combobox-option-focused");if(t){var e=this.dropdown.getBoundingClientRect(),o=t.getBoundingClientRect(),i=o.top-e.top;i<0?t.scrollIntoView(!0):i+o.height>e.height&&t.scrollIntoView(!1)}},g.prototype.renderItems=function(t){t&&e(this.inputContainer.querySelectorAll("[data-value]"));for(var o in this.items){var i,r=this.items[o];this.onRenderItem?(i=this.onRenderItem(r),s(i)&&(i=n(i))):(i=f("div.combobox-item"),i.textContent=r.label),c(i,"data-value",r.value),c(i,"data-label",r.label),this.inputContainer.insertBefore(i,this.inputEl)}},g.prototype.renderOptions=function(t){t&&(this.dropdownElements=[]);for(var e in this.options){var o,i=this.options[e];this.dropdownElements[i.value]||(this.onRenderOption?(o=this.onRenderOption(i),s(o)&&(o=n(o))):(o=f("div.combobox-option"),o.textContent=i.label),c(o,"data-value",i.value),c(o,"data-label",i.label),this.dropdownElements[i.value]=o)}},g.prototype.populateDropdown=function(){var e=this.getInputValue(),o=this.getSuggestions(e);t(this.dropdown),this.opt.create&&this.dropdown.appendChild(this.addEl),o.length<1?l(this.dropdown,"combobox-dropdown-empty"):p(this.dropdown,"combobox-dropdown-empty");for(var i in o){if(i>this.opt.maxSuggestions)break;var n=this.dropdownElements[o[i].value];n&&this.dropdown.appendChild(n)}},g.prototype.getSuggestions=function(t){var e=this,o=new RegExp(t,"i"),i=this.options.filter(function(t){return!e.findItemByValue(t.value)&&o.test(t.label)});return i.sort(function(e,o){return o.label.toLowerCase().indexOf(t)<e.label.toLowerCase().indexOf(t)?1:o.label.toLowerCase().indexOf(t)>e.label.toLowerCase().indexOf(t)?-1:e.label.toLowerCase().localeCompare(o.label.toLowerCase())}),i},g.prototype.toggleHighlight=function(){for(var t=d(this.getInputValue()),e=u(this.dropdown.querySelectorAll(".combobox-option")),o=new RegExp(t,"i"),i=0;i<e.length;i++){var n=e[i],s=c(n,"data-label");if(t&&0!==t.length){var r=o.exec(s);n.innerHTML=s.replace(o,'<span class="combobox-highlight">'+r[0]+"</span>")}else n.innerHTML=s}},g.prototype.updateDropdown=function(t){var e=this.getInputValue();(t||this.lastValue!=e)&&(this.populateDropdown(),this.toggleHighlight(),this.showDropdown()),this.lastValue=e,this.toggleOptionFocus(),this.toggleCompletion(),this.togglePlaceholder(),this.toggleAdd()},g.prototype.showDropdown=function(){this.dropdown.childNodes.length>0?l(this.container,"combobox-dropdown-visible"):p(this.container,"combobox-dropdown-visible")},g.prototype.hideDropdown=function(){p(this.container,"combobox-dropdown-visible"),this.toggleOptionFocus()},g.prototype.addValue=function(t){if(0===t.length)return!1;var e=this.findOptionByValue(t),o=this.findItemByValue(t);if(o||!e&&!this.opt.create||this.onWillAdd&&this.onWillAdd(t)===!1)return!1;var i={value:e?e.value:t,label:e?e.label:t};this.items.push(i);var r;this.onRenderItem?(r=this.onRenderItem(i),s(r)&&(r=n(r))):(r=f("div.combobox-item"),r.textContent=i.label),c(r,"data-value",i.value),c(r,"data-label",i.label),this.inputContainer.insertBefore(r,this.inputEl),this.onDidAdd&&this.onDidAdd(t);var l=this.dropdownElements[t];return l&&(l.nextSibling?this.toggleOptionFocus(l.nextSibling):l.previousSilbing&&this.toggleOptionFocus(l.previousSilbing)),this.updateDropdown(!0),this.resetHeight(),!0},g.prototype.updateElementValue=function(){return},g.prototype.updateInputSize=function(){this.tempEl.innerHTML=this.getInputValue(),this.inputEl.style.width=this.tempEl.offsetWidth+4+"px"},g.prototype.focusInput=function(){this.inputEl.focus()},g.prototype.focus=function(t){this.focusInput(),this.updateDropdown(this.opt.openOnFocus)},g.prototype.blur=function(t){return t!==!0&&i(this.activationEvent.srcElement,this.container)?(t.stopImmediatePropagation&&t.stopImmediatePropagation(),void(t.preventDefault&&t.preventDefault())):(this.inputEl.blur(),void this.hideDropdown())},g.prototype.getItems=function(){return 1===this.opt.maxSelected?this.items[0]:this.items},g.prototype.getInputValue=function(){return this.inputEl.value},g.prototype.hasFocused=function(){return this.inputContainer.querySelectorAll(".combobox-item-focused").length>0},g.prototype.removeFocus=function(){p(this.inputContainer.querySelectorAll(".combobox-item-focused"),"combobox-item-focused")},g.prototype.removeFocused=function(){o(this.inputContainer.querySelectorAll(".combobox-item-focused"),function(t){this.removeValue(c(t,"data-value"))}.bind(this)),this.updateDropdown()},g.prototype.removeValue=function(t){if(0===t.length||this.onWillRemove&&!this.onWillRemove(t))return!1;var e=null,o=this.items.findIndex(function(o){return o.value==t&&(e=o,!0)});o!=-1&&this.items.splice(o,1);var i=this.inputContainer.querySelector('[data-value="'+e.value+'"]');return i&&this.inputContainer.removeChild(i),this.onDidRemove&&this.onDidRemove(e),this.updateElementValue(),!0},g.prototype.resetHeight=function(){var t=this.inputContainer.getBoundingClientRect();t.height>0&&(this.container.style.maxHeight=t.height+"px")},g.prototype.resetInput=function(){this.inputEl.value="",this.updateInputSize(),this.updateDropdown(!0)},this.ComboBox=g}).call(this);