(function(){"use strict";function t(t){if(t)for(;t.firstChild;)t.removeChild(t.firstChild)}function e(t,e){!t||0===t.length&&t!=window||(t.length?Array.prototype.forEach.call(t,function(t,o){e(t)}):e(t))}function o(t,e){return t?t.parentNode==e?!0:o(t.parentNode,e):!1}function i(t){var e=document.createElement("div");return e.innerHTML=t,e.firstChild}function n(t){return"string"==typeof t}function s(t,o,i,n){e(t,function(t){var e=o.split(" ");for(var s in e)t.addEventListener(e[s],i,n)})}function r(t){"function"==typeof t.stopPropagation?(t.stopPropagation(),t.preventDefault()):window.event&&window.event.hasOwnProperty("cancelBubble")&&(window.event.cancelBubble=!0)}function l(t,e){if(void 0===t.ontouchstart)return void s(t,"click",e);var o=!1;s(t,"touchstart",function(t){o=!0}),s(t,"touchend",function(t){o&&(e(t),r(t))}),s(t,"touchcancel touchleave touchmove",function(t){o=!1})}function u(t,o){e(t,function(t){if(t.classList){var e=o.split(" ");for(var i in e)t.classList.add(e[i])}else t.className+=" "+o})}function p(t,o){e(t,function(t){if(t.classList){var e=o.split(" ");for(var i in e)t.classList.remove(e[i])}else t.className=t.className.replace(new RegExp("(^|\\b)"+o.split(" ").join("|")+"(\\b|$)","gi")," ")})}function h(t){return Array.prototype.slice.call(t,0)}function a(t,e){return t?t.classList?t.classList.contains(e):new RegExp("(^| )"+e+"( |$)","gi").test(t.className):void 0}function c(t,o){e(t,function(t){a(t,o)?p(t,o):u(t,o)})}function d(t,o,i){return void 0===i&&t&&void 0!==t.getAttribute?t.getAttribute(o):void e(t,function(t){t.setAttribute(o,i)})}function f(t){return t.replace(/(^\s+|\s+$)/g,"")}function v(t,e,o,i){var n,s;e||(e={}),-1!==t.indexOf(".")&&(s=t.split("."),t=s[0],s.shift(),e["class"]=s.join(" ")),-1!==t.indexOf("#")&&(s=t.split("#"),t=s[0],e.id=s[1]),n=document.createElement(t);for(var r in e)n.setAttribute(r,e[r]);return o&&o.appendChild(n),i&&(n.innerHTML=i),n}function g(t){void 0===t&&(t={});var e={};for(var o in m)e[o]=void 0!==t[o]?t[o]:m[o];return e}var b={leftArrow:37,rightArrow:39,upArrow:38,downArrow:40,enter:13,backspace:8,esc:27},m={options:null,values:null,delimiter:",",create:!0,createOnBlur:!0,openOnFocus:!0,closeAfterSelect:!0,selectOnTab:!0,maxSelected:0,maxSuggestions:1/0},w=function(t,o){this.opt=g(o),this.el=t,this.el&&(this.el.style.display="none",this.isSelectBox="select"==this.el.nodeName.toLowerCase(),this.container=v("div.combobox"),this.el.parentNode.insertBefore(this.container,this.el),this.container.appendChild(this.el),this.inputContainer=v("div.combobox-input-container",null,this.container),this.dropdown=v("div.combobox-dropdown",null,this.container),this.values=[],this.options=[],this.dropdownElements=[],this.isSelectBox&&e(this.el.querySelectorAll("option"),function(t){this.options.push(t.textContent),null!==d(t,"selected")&&void 0!==d(t,"selected")&&this.values.push(t.textContent)}.bind(this)),this.inputEl=v("input.combobox-input",null,this.inputContainer),this.completionEl=v("div.combobox-input-completion"),this.addEl=v("div.combobox-add"),this.tempEl=v("div.combobox-temp",null,this.container),this.tempEl.style.letterSpacing=this.inputEl.style.letterSpacing,this.tempEl.style.fontSize=this.inputEl.style.fontSize,this.tempEl.style.fontFamily=this.inputEl.style.fontFamily,this.tempEl.style.fontWeight=this.inputEl.style.fontWeight,this.tempEl.style.textTransform=this.inputEl.style.textTransform,d(this.inputContainer,"placeholder",d(this.el,"placeholder")),s(this.inputContainer,"focus",this.focus.bind(this)),s(this.inputEl,"blur",this.blur.bind(this)),s(this.inputEl,"focus",this.focus.bind(this)),s(this.inputEl,"input",this.onInput.bind(this)),s(this.inputEl,"keydown",this.onKeyDown.bind(this)),l(this.inputContainer,this.onClick.bind(this)),l(document.documentElement,this.onClick.bind(this)),s(document.documentElement,"mouseover",this.onHover.bind(this)),this.renderOptions(),this.togglePlaceholder(),this.resetHeight(),this.el.combobox=this)};w.prototype.onClick=function(t){document.activeElement.isSameNode(this.inputEl)||this.focus(),this.activationEvent=t;var e=t.srcElement;o(e,this.container)?o(e,this.dropdown)?this.onDropdownOptionClick(t):a(e,"combobox-value")&&c(e,"combobox-value-focused"):this.blur()},w.prototype.onHover=function(t){this.activationEvent=t;var e=t.srcElement;o(e,this.container)&&(a(e,"combobox-add")||a(e,"combobox-option"))&&this.toggleOptionFocus(e)},w.prototype.onInput=function(){this.updateInputSize(),this.updateDropdown()},w.prototype.onKeyDown=function(t){switch(t.keyCode){case b.rightArrow:this.onKeyRightArrow(t);break;case b.leftArrow:this.onKeyLeftArrow(t);break;case b.downArrow:this.onKeyDownArrow(t);break;case b.upArrow:this.onKeyUpArrow(t);break;case b.backspace:this.onKeyBackspace(t);break;case b.esc:this.onKeyEsc(t);break;case b.enter:this.onKeyEnter(t)}},w.prototype.onKeyEsc=function(t){this.hideDropdown()},w.prototype.onKeyEnter=function(t){var e=this.inputEl.value=f(this.getInputValue()),o=this.dropdown.querySelector(".combobox-option-focused");o&&this.addValue(d(o,"data-value"))?this.resetInput():(this.values.indexOf(e)>=0||this.addValue(e))&&this.resetInput()},w.prototype.onKeyBackspace=function(t){return 0!==this.getInputValue().length&&(this.inputEl.selectionStart>0||this.inputEl.selectionStart!=this.inputEl.selectionEnd)?void 0:this.hasFocused()?(this.removeFocused(),void this.updateInputSize()):void(this.inputEl.previousSibling&&(this.removeValue(d(this.inputEl.previousSibling,"data-value")),this.focusInput(),this.updateInputSize(),this.updateDropdown(!0)))},w.prototype.onKeyLeftArrow=function(t){0===this.getInputValue().length&&(t.shiftKey?this.inputEl.previousSibling&&c(this.inputEl.previousSibling,"combobox-value-focused"):this.removeFocus(),this.inputEl.previousSibling&&this.inputContainer.insertBefore(this.inputEl,this.inputEl.previousSibling),this.focusInput())},w.prototype.onKeyRightArrow=function(t){0===this.getInputValue().length&&(t.shiftKey?this.inputEl.nextSibling&&c(this.inputEl.nextSibling,"combobox-value-focused"):this.removeFocus(),this.inputEl.nextSibling?this.inputContainer.insertBefore(this.inputEl,this.inputEl.nextSibling.nextSibling):this.inputContainer.appendChild(this.inputEl),this.focusInput())},w.prototype.onKeyUpArrow=function(t){this.toggleOptionFocus("prev"),t.preventDefault()},w.prototype.onKeyDownArrow=function(t){this.toggleOptionFocus("next"),t.preventDefault()},w.prototype.onDropdownOptionClick=function(t){var e=t.srcElement;(a(e,"combobox-option")||a(e,"combobox-add"))&&(this.addValue(d(e,"data-value"))&&this.resetInput(),this.focusInput())},w.prototype.toggleCompletion=function(){var t=this.dropdown.querySelector(".combobox-option-focused"),e=d(t,"data-value"),o=this.getInputValue();t&&0!==o.length&&e&&0===e.toLowerCase().indexOf(o.toLowerCase())?(this.completionEl.textContent=e.substring(o.length),this.inputEl.nextSibling?this.inputContainer.insertBefore(this.completionEl,this.inputEl.nextSibling):this.inputContainer.appendChild(this.completionEl)):(this.completionEl.textContent="",this.completionEl.parentNode&&this.completionEl.parentNode.removeChild(this.completionEl))},w.prototype.togglePlaceholder=function(){d(this.inputContainer,"data-completion")||1!==this.inputContainer.childNodes.length||0!==this.getInputValue().length?p(this.inputContainer,"combobox-placeholder"):u(this.inputContainer,"combobox-placeholder")},w.prototype.toggleOptionFocus=function(){var t=this.dropdown.querySelector(".combobox-option-focused");if(arguments[0]&&arguments[0].nodeName)return t&&p(t,"combobox-option-focused"),void u(arguments[0],"combobox-option-focused");var e=this.dropdown.querySelectorAll(".combobox-option");if(!e||0===e.length)return void(this.opt.create&&u(this.addEl,"combobox-option-focused"));if(this.opt.create&&p(this.addEl,"combobox-option-focused"),!t)return void u(e[0],"combobox-option-focused");if(arguments[0]){var o;"next"==arguments[0]?o=t.nextSibling:"prev"==arguments[0]&&(o=t.previousSibling),o&&(u(o,"combobox-option-focused"),p(t,"combobox-option-focused"),this.scrollFocusedOptionIntoView(),this.toggleCompletion())}},w.prototype.toggleHighlight=function(){for(var t=f(this.getInputValue()),e=h(this.dropdown.querySelectorAll(".combobox-option")),o=new RegExp(t,"i"),i=0;i<e.length;i++){var n=e[i],s=d(n,"data-value");if(t&&0!==t.length){var r=o.exec(s);n.innerHTML=s.replace(o,'<span class="combobox-highlight">'+r[0]+"</span>")}else n.innerHTML=s}},w.prototype.toggleAdd=function(){var t=f(this.getInputValue());0===t.length?(this.addEl.textContent="",d(this.addEl,"data-value","")):(this.addEl.textContent="Add "+t,d(this.addEl,"data-value",t))},w.prototype.scrollFocusedOptionIntoView=function(){var t=this.dropdown.querySelector(".combobox-option-focused");if(t){var e=this.dropdown.getBoundingClientRect(),o=t.getBoundingClientRect(),i=o.top-e.top;0>i?t.scrollIntoView(!0):i+o.height>e.height&&t.scrollIntoView(!1)}},w.prototype.renderOptions=function(t){t&&(this.dropdownElements=[]);for(var e in this.options){var o,s=this.options[e];this.dropdownElements[s]||(this.onRenderOption?(o=this.onRenderOption(s),n(o)&&(o=i(o))):(o=v("div.combobox-option"),o.textContent=s),d(o,"data-value",s),this.dropdownElements[s]=o)}},w.prototype.populateDropdown=function(){var e=this.getInputValue(),o=this.getSuggestions(e);t(this.dropdown),this.opt.create&&this.dropdown.appendChild(this.addEl);for(var i in o){if(i>this.opt.maxSuggestions)break;var n=this.dropdownElements[o[i]];n&&this.dropdown.appendChild(n)}},w.prototype.getSuggestions=function(t){var e=new RegExp(t,"i"),o=this.values,i=this.options.filter(function(t){return o.indexOf(t)>=0?!1:e.test(t)});return i.sort(function(e,o){return o.toLowerCase().indexOf(t)<e.toLowerCase().indexOf(t)?1:o.toLowerCase().indexOf(t)>e.toLowerCase().indexOf(t)?-1:e.toLowerCase().localeCompare(o.toLowerCase())}),i},w.prototype.updateDropdown=function(t){var e=this.getInputValue();(t||this.lastValue!=e)&&(this.populateDropdown(),this.toggleHighlight(),this.showDropdown()),this.lastValue=e,this.toggleOptionFocus(),this.toggleCompletion(),this.togglePlaceholder(),this.toggleAdd()},w.prototype.showDropdown=function(){this.dropdown.childNodes.length>0?u(this.container,"combobox-dropdown-visible"):p(this.container,"combobox-dropdown-visible")},w.prototype.hideDropdown=function(){p(this.container,"combobox-dropdown-visible"),this.toggleOptionFocus()},w.prototype.addValue=function(t){if(0===t.length)return!1;var e=this.options.indexOf(t)>=0,o=this.values.indexOf(t)>=0;if(o||!e&&!this.opt.create||this.onWillAdd&&this.onWillAdd(t)===!1)return!1;this.values.push(t);var s;this.onRenderValue?(s=this.onRenderValue(t),n(s)&&(s=i(s))):(s=v("div.combobox-value"),s.textContent=t),d(s,"data-value",t),this.inputContainer.insertBefore(s,this.inputEl),this.onDidAdd&&this.onDidAdd(t);var r=this.dropdownElements[t];return r&&(r.nextSibling?this.toggleOptionFocus(r.nextSibling):r.previousSilbing&&this.toggleOptionFocus(r.previousSilbing)),this.updateDropdown(!0),this.resetHeight(),this.updateElementValue(),!0},w.prototype.updateElementValue=function(){var t=this.el.nodeName.toLowerCase();if("select"==t){this.el.innerHTML="";for(var e in this.values)v("option",{selected:""},this.el,this.values[e])}else"input"==t?this.el.value=this.values.join(this.opt.delimiter):"textarea"==t&&(this.el.innerHTML=this.values.join(this.opt.delimiter))},w.prototype.updateInputSize=function(){this.tempEl.innerHTML=this.getInputValue(),this.inputEl.style.width=this.tempEl.offsetWidth+4+"px"},w.prototype.focusInput=function(){this.inputEl.focus()},w.prototype.focus=function(t){this.focusInput(),this.updateDropdown(this.opt.openOnFocus)},w.prototype.blur=function(t){return t!==!0&&o(this.activationEvent.srcElement,this.container)?(t.stopImmediatePropagation&&t.stopImmediatePropagation(),void(t.preventDefault&&t.preventDefault())):(this.inputEl.blur(),void this.hideDropdown())},w.prototype.getItems=function(){return this.options},w.prototype.getValues=function(){return 1===this.opt.maxSelected?this.values[0]:this.values},w.prototype.getInputValue=function(){return this.inputEl.value},w.prototype.hasFocused=function(){return this.inputContainer.querySelectorAll(".combobox-value-focused").length>0},w.prototype.removeFocus=function(){p(this.inputContainer.querySelectorAll(".combobox-value-focused"),"combobox-value-focused")},w.prototype.removeFocused=function(){e(this.inputContainer.querySelectorAll(".combobox-value-focused"),function(t){this.removeValue(d(t,"data-value"))}.bind(this)),this.updateDropdown()},w.prototype.removeValue=function(t){if(0===t.length||this.onWillRemove&&!this.onWillRemove(t))return!1;var e=this.values.indexOf(t);-1!=e&&this.values.splice(e,1);var o=this.inputContainer.querySelector('[data-value="'+t+'"]');return o&&this.inputContainer.removeChild(o),this.onDidRemove&&this.onDidRemove(t),this.updateElementValue(),!0},w.prototype.resetHeight=function(){var t=this.inputContainer.getBoundingClientRect();this.container.style.maxHeight=t.height+"px"},w.prototype.resetInput=function(){this.inputEl.value="",this.updateInputSize(),this.updateDropdown(!0)};var y=[];this.ComboBox=function(t,e){var o;o=n(t)?document.querySelector(t):t;for(var i in y)if(y[i].el.isSameNode(o))return y[i];var s=new w(o,e);return y.push(s),s},this.ComboBox.globals=m}).call(this);